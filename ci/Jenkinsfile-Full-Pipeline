properties([
    pipelineTriggers([
        [$class: "SCMTrigger", scmpoll_spec: "H/2 * * * *"],
    ])
])

GIT_BRANCH=''

timestamps {

node ('beta-label') {

	stage ('Hello Git - Checkout') {
 	 def scmVars = checkout([$class: 'GitSCM', branches: [[name: '**']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: '', url: 'https://github.com/Fiercely/python-sample-ci']]])
	 env.GIT_COMMIT = scmVars.GIT_COMMIT
	 env.GIT_BRANCH = scmVars.GIT_BRANCH.replace("origin/", "")
	 GIT_BRANCH=env.GIT_BRANCH
	}
	stage ('Hello Git - Build') {
 			// Shell build step
			sh """
			python -m unittest discover tests
			 """
		}
	}
node ('alpha-label'){
    if (GIT_BRANCH == "web") {
    stage('Deploy Stage') {
       env.GIT_BRANCH = GIT_BRANCH
       echo env.GIT_BRANCH
       checkout([$class: 'GitSCM', branches: [[name: '*/web']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: '', url: 'https://github.com/Fiercely/python-sample-ci']]])
       script{
                withEnv(['JENKINS_NODE_COOKIE=dontkill']) {


                sh """
                #in case it's already running
                if screen -list | grep -q "webapp"; then
                screen -X -S webapp quit
                fi
                #run the application as screen process ( please don't do this in production, use    uWSGI, apache , gunicorn or other..)
                pip install --user -r requirements.txt
                BUILD_ID=dontKillMe screen -S webapp -d -m -L bash -c "python app/app.py"
                """
	            }
            }
        }
    }
}
}
